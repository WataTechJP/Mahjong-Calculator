name: Generate Plan From Issue

on:
  workflow_dispatch:
  issues:
    types: [opened, reopened, edited, labeled]

permissions:
  contents: write
  issues: read
  pull-requests: write

jobs:
  generate-plan:
    runs-on: ubuntu-latest
    env:
      ISSUE_NUMBER: ${{ github.event.issue.number }}
      ISSUE_TITLE: ${{ github.event.issue.title }}
      ISSUE_BODY: ${{ github.event.issue.body }}
      ISSUE_URL: ${{ github.event.issue.html_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate plan markdown
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p plans
          PLAN_FILE="plans/issue-${ISSUE_NUMBER}.md"

          cat > "$PLAN_FILE" <<PLAN
          # Issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}

          Issue URL: ${ISSUE_URL}

          ## Original Issue
          ${ISSUE_BODY}

          ## Goal
          - Issueの内容を満たすための実装方針を明確化する。

          ## Scope
          - In Scope:
            - `frontend/` と `backend/` のうち、Issueに関連する変更点の整理
            - 必要な画面/API/状態管理の修正タスク定義
          - Out of Scope:
            - 追加要件の拡張実装
            - 本Issueに無関係なリファクタ

          ## Implementation Tasks
          - [ ] Issue本文を要件単位に分解する
          - [ ] 影響範囲を `frontend/` / `backend/` / API契約に分類する
          - [ ] 実装手順を依存順で並べる（先に型・データ構造、次にUI/API）
          - [ ] 完了条件（受け入れ基準）を各タスクに紐付ける
          - [ ] レビュー観点（回帰リスク、互換性、操作性）を整理する

          ## Risks
          - Issue本文の情報不足により、実装前に追加確認が必要になる可能性。
          - UI変更時に既存フロー（開始/記録/履歴）へ回帰が入る可能性。
          - API変更が入る場合、frontend側との不整合が発生する可能性。

          ## Validation
          - [ ] 影響機能の手動確認手順を記載する
          - [ ] 既存の主要フローが維持されることを確認する
          - [ ] 差分レビューで Scope外変更がないことを確認する

          ## Rollback
          - 問題発生時はこのIssue向け変更コミットのみをrevertする。
          - API契約変更がある場合は、frontend/backendを同時に元に戻す。
          PLAN

          if [[ ! -s "$PLAN_FILE" ]]; then
            echo "Generated plan file is empty"
            exit 1
          fi

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          branch: bot/issue-plan-${{ github.event.issue.number }}
          title: "docs(plan): add issue-${{ github.event.issue.number }} plan"
          commit-message: "docs(plan): add plan for issue #${{ github.event.issue.number }}"
          body: |
            Auto-generated implementation plan from GitHub Issue #${{ github.event.issue.number }}.

            - Source: ${{ github.event.issue.html_url }}
            - Output: `plans/issue-${{ github.event.issue.number }}.md`
          add-paths: |
            plans/issue-${{ github.event.issue.number }}.md
