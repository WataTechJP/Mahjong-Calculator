# Mahjong Calculator 改善計画（レビュー結果）

## 目的
このプロジェクトを「実戦で使える麻雀点数計算アプリ」にするため、現状コードの欠点を整理し、優先度付きで改善方針を定義する。

## 主要な問題点（理由付き）

### P0: 点数ロジックの不整合・誤差リスク
1. フロントとバックで点数適用ロジックが二重化されている。  
   根拠: `frontend/src/store/gameStore.ts:77`, `backend/main.py:252`。  
   理由: 仕様差分が出ると同一入力で結果が変わる。
2. ツモ時の本場分配が `Math.ceil(honbaBonus / 3)` で端数調整され、総和誤差が出うる。  
   根拠: `frontend/src/store/gameStore.ts:133`, `frontend/src/store/gameStore.ts:137`。  
3. `RecordWinScreen` はプリセット表で計算、`TileRecognitionScreen` はAPI計算を使い、計算経路が異なる。  
   根拠: `frontend/src/screens/RecordWinScreen.tsx:27`, `frontend/src/screens/TileRecognitionScreen.tsx:279`。

### P1: ルール進行の実装不足
1. 南4以降の終局条件（オーラス終了、延長、西入/サドンデス等）が未定義。  
   根拠: `frontend/src/store/gameStore.ts:225`（東→南のみ）。
2. 対局開始時に「東風戦 / 半荘」の選択ができない。  
   理由: ルール選択が固定だと、ユーザーの普段の卓ルールに合わせられない。
3. 東場終了時の「30000点終了条件（トップ30000点未満なら南場へ）」が設定できない。  
   補足: これは一般に「トップ30000点終了ルール」「30000点終了条件」と呼ばれることが多い（延長戦あり東風戦 / サドンデス条件付き東風戦に相当）。
4. リーチ棒処理の一貫性不足。`isRiichi` UI が得点処理に反映されず、供託が増えない。  
   根拠: `frontend/src/screens/RecordWinScreen.tsx:69`, `frontend/src/screens/RecordWinScreen.tsx:149`, `frontend/src/store/gameStore.ts:241`。  
   理由: `addRiichiStick()` は実装済みだが、和了入力画面でリーチON時に呼ばれていない。
5. Undo は点数中心で、局進行ルールの再現性が弱い。  
   根拠: `frontend/src/store/gameStore.ts:252`。

### P1: 入力バリデーション不足
1. 手牌枚数・副露整合性チェックが弱く、不正形でも計算へ進める。  
   根拠: `frontend/src/screens/TileRecognitionScreen.tsx:255`（最低1枚のみ判定）。
2. 副露 `opened` が常に true になるバグ。  
   根拠: `frontend/src/screens/TileRecognitionScreen.tsx:285`（`m.type !== 'kan' || true`）。
3. 手入力で同一牌を4枚超えて選択できる可能性がある。  
   理由: 実牌構成上、同一牌は最大4枚までに制限する必要がある。
4. 副露入力情報が不足しており、鳴き元（誰から）と明槓/暗槓を区別できない。  
   理由: 点数計算条件の再現性と履歴の説明可能性が下がる。

### P2: UX/運用上の課題
1. `HistoryScreen` 内で `renderItem` に Hook を置いており保守性が低い。  
   根拠: `frontend/src/screens/HistoryScreen.tsx:40`。
2. API認証を有効化した場合、フロントが `x-api-key` を送らないため通信失敗する。  
   根拠: `backend/main.py:119`, `frontend/src/api/client.ts:7`。

## 改善方針
1. **点数計算・適用ロジックを1箇所へ統一**（推奨: backendを唯一の正とし、frontendは結果表示のみ）。
2. **ルールエンジン層を導入**し、局進行・供託・終局判定を state machine 化する。
3. **入力検証を強化**（14枚整合、副露の枚数/種別、和了条件）。
4. **API契約を明文化**（認証ヘッダ、エラーレスポンス、計算モード）。
5. **画面ごとの計算経路を統一**（RecordWin もAPI経由 or 共有計算モジュール）。

## 実行計画（段階）

### Phase 1（最優先）
- [x] 点数移動ロジックを backend `/apply-score` に一本化し、frontend の直接計算を削除。  
- [x] ツモ本場配分の丸め仕様を固定（100点単位で総和一致テスト付き）。
- [x] `TileRecognitionScreen` の `opened` バグ修正。

### Phase 2
- [x] 局進行ルール（東南戦終了条件、トップ確定条件）を仕様化して実装。  
- [x] 開始時にゲームモードを選択可能にする（東風戦 / 半荘）。
- [x] 東場終了時の「30000点終了条件」のON/OFFを設定可能にする。  
      ON時: 東4終了時トップが30000点以上なら終局、未満なら南場へ進行。
- [x] リーチ宣言時に `addRiichiStick()` を必ず実行し、供託増加・宣言者-1000点・和了時の供託受け取りまで一貫反映。
- [x] リーチ宣言をUI・得点処理・履歴へ一貫反映（誰がいつ宣言したか履歴に残す）。
- [x] 手牌/副露バリデーションを事前実施し、エラーメッセージを具体化。
- [x] 手入力時、同一牌の選択上限を4枚に制限する（5枚目は入力拒否 + 警告表示）。
- [x] 副露入力を拡張し、以下を選択可能にする。  
      - 鳴き種別: チー / ポン / 明槓 / 暗槓  
      - 鳴き元: 上家 / 対面 / 下家（自分からは不可）
- [x] 副露情報（鳴き種別・鳴き元）を履歴に保存し、後から確認可能にする。

## 追加仕様メモ（用語）
- 「東場終了時トップ30000点未満なら南場へ」は、プロダクト内では次の文言で統一する。  
  - 表示名: **30000点終了条件**  
  - ヘルプ補足: **トップ30000点終了ルール（延長戦あり東風戦）**

### Phase 3
- [x] `HistoryItem` を独立コンポーネント化し Hook 位置を適正化。  
- [x] APIクライアントに `x-api-key` と環境別 `API_BASE_URL` 設定を導入。  
- [x] 回帰チェック用の最小テスト（スコア計算ケース表）を追加。
- [x] 手入力/画像入力画面に「選択牌を全削除」ボタンを追加する（手牌・副露・ドラを一括クリア）。

## 完了条件
- 同一入力で画面経路に依らず同一得点になる。  
- 本場/供託/親番移動を含む 1 半荘シミュレーションの総和が常に一致する。  
- 不正入力時に計算前にブロックされ、理由がUIに表示される。
